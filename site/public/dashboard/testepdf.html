<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTE PARA CONSTRUIR OS GRAFICOS DO PDF</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div style="width: 50%; margin: auto;">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        window.onload = function () {
            obterDadosRede()
        }

        function obterDadosRede() {

            const labels = []
            const data = [[], []]

            fetch("/relatorios/buscarSelectRede", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    selectRedeServer: selectRede
                })
            })
                .then((resposta) => resposta.json())
                .then((dados) => {
                    dados.reverse()

                    const vetorDowload = []
                    const vetorUpload = []
                    const momentoFormatado = []

                    for (let i = 0; i < dados.length; i++) {

                        if (dados[i].Componente == 5) {
                            vetorDowload.push(dados[i].Dado)
                        }
                        if (dados[i].Componente == 6) {
                            vetorUpload.push(dados[i].Dado)
                        }
                    }

                    for (let i = 0; i < dados.length/2; i++) {
                        const momento = new Date(dados[i].DataHora)
                        const momentoFormatadoAtual = momento.toISOString().slice(1, 19)
                        momentoFormatado.push(momentoFormatadoAtual)

                    }

                    console.table(momentoFormatado)
                    console.table(vetorDowload)
                    console.table(vetorUpload)

                    labels.push(...momentoFormatado)
                    data[0].push(...vetorDowload)
                    data[1].push(...vetorUpload)

                    const config = {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Download',
                                data: data[0],
                                fill: false,
                                borderColor: '#845ED7',
                                backgroundColor: '#845ED7',
                                tension: 0.1
                            }, {
                                label: 'Upload',
                                data: data[1],
                                fill: false,
                                borderColor: '#45A7A4',
                                backgroundColor: '#45A7A4',
                                tension: 0.1
                            }]
                        },
                        options: {
                            plugins: {
                                legend: {
                                    display: true
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        color: 'blue',
                                        lineWidth: 0.4,
                                        borderDash: [1, 1]
                                    },
                                    ticks: {
                                        color: 'green'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'black',
                                        lineWidth: 0.4,
                                        borderDash: [1, 1]
                                    },
                                    ticks: {
                                        callback: (value) => value + ' Mb/s',
                                        color: 'red'
                                    }
                                }
                            },
                            layout: {
                                padding: {
                                    left: 1
                                }
                            }
                        }
                    };

                    const myChart = new Chart(document.getElementById('myChart'), config)
                })
                .catch((error) => {
                    console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`)
                });
        }

        var selectRede =
            `SELECT TOP 40 
            Dado_Capturado AS Dado,
            fkCompMoniExistentes AS Componente,
            CONCAT(Data_captura, ' ', Hora_captura) AS DataHora
        FROM 
            Monitoramento
        WHERE
            fkCompMoniExistentes IN (5, 6) AND 
            fkEmpMaqCompMoni = 1
        ORDER BY
            Data_captura DESC,
            Hora_captura ASC;`

        // var selectRede =
        //     `SELECT TOP 20
        //     Dado_Capturado AS Dado,
        //     fkCompMoniExistentes AS Componente,
        //     CONCAT(Data_captura, ' ', Hora_captura) AS DataHora
        // FROM
        //     Monitoramento
        // WHERE
        //     fkCompMoniExistentes IN (5, 6) AND
        //     fkEmpMaqCompMoni = 1 AND
        //     (
        //     Data_captura > '${varDtInicio}' OR
        //     (Data_captura = '${varDtInicio}' AND Hora_captura >= '${varHrInicio}')
        //     ) AND
        //     (
        //     Data_captura < '${varDtFim}' OR
        //     (Data_captura = '${varDtFim}' AND Hora_captura <= '${varHrFim}')
        //     )
        // ORDER BY
        //     Data_captura DESC,
        //     Hora_captura ASC;
        // `
    </script>
</body>

</html>