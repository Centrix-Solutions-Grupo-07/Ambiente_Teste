<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../assets/icon/favicon.ico">
    <title>Dashboard | Funcionários</title>
    <link rel="stylesheet" href="../css/barra_lateral.css">
    <link rel="stylesheet" href="../css/dash_funcionarios.css">
    <script src="../js/dashboard_funcionarios.js"></script>
    <script src="../js/notificacao.js"></script>
    <script src="../js/andar.js"></script>
    <script src="../js/nivelAcesso.js"></script>
</head>

<body onload="buscarFuncionarios(), buscarAndares(), listarLateral()">
    <div class="container_principal">
        <div class="barra_lateral" id="lateral_barra"></div>
        <div class="area_dash">
            <div class="dash_superior">
                <div class="bem_vindo">
                    <span class="text_bemVindo1">
                        Funcionários
                    </span>
                    <span class="text_bemVindo2">
                        Veja as princípais informações dos seus funcionários, cadastre e de
                        permissões para eles.
                    </span>
                </div>
            </div>
            <div class="div_central">
                <div class="div_funcionarios" id="div_funcionarios"></div>
                <div class="div_direita">
                    <div class="div_titulo">
                        Novo Funcionário
                    </div>
                    <div class="div_cadastro">
                        <p>
                            Nome
                        </p>
                        <input type="text" class="input_cadastro" id="nome_input"/>
                        <p>
                            Email
                        </p>
                        <span id="spanEmail"></span>
                        <input type="text" class="input_cadastro" id="email_input"/>
                        <p>
                            Nivel de Acesso
                        </p>
                        <select name="acesso" id="acesso_input" class="select_cadastro">
                            <option value="1">Lílas</option>
                            <option value="2">Magenta</option>
                            <option value="3">Violeta</option>
                            <option value="4">Púrpura</option>
                        </select>
                        <p>
                            Selecione o Andar que deseja monitorar
                        </p>
                        <select name="andares" class="select_andares" id="andares"></select>
                    </div>
                    <div onclick="cadastrarFuncionario()" class="botao_cadastrar">
                        Cadastrar
                    </div>

                    <div>
                        <p>
                            Token de Acesso
                        </p>
                        <div class="div_paiToken">
                            <div class="div_token" id="divToken"></div>
                        </div>
                        <p>
                            *Não perca este acesso, será necessário para o primeiro login e futura alteração da senha.
                        </p>
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script>
    async function buscarFuncionarios(){
        var idEmpresa = sessionStorage.Empresa;
        try {
            var resposta = await fetch("/funcionarios/buscarFuncionarios", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idEmpresaServer: idEmpresa,
                })
            });
            if (resposta.ok) {
                var respostaJson = await resposta.json();
                console.log('JSON Funcionarios: ', respostaJson);
                var divFuncionarios = document.getElementById("div_funcionarios");
                for (let i = 0; i < respostaJson.length; i++) {
                    var acessoUser = respostaJson[i].nivelAcesso;
                    var idFuncionario = respostaJson[i].idFuncionario;

                    var divFuncionario = document.createElement("div");
                    divFuncionario.className = "div_funcionario";

                    var divInformacoes = document.createElement("div");
                    var pNome = document.createElement("p");
                    var pEmail = document.createElement("p");
                    var pComputador = document.createElement("p");
                    divInformacoes.className = "div_informacoes";
                    pNome.className = "p_nome";
                    pEmail.className = "p_email";
                    pComputador.className = "p_computador";
                    pNome.innerHTML = respostaJson[i].nome;
                    pEmail.innerHTML = respostaJson[i].email;
                    pComputador.innerHTML = respostaJson[i].idDispositivo;
                    divInformacoes.appendChild(pNome);
                    divInformacoes.appendChild(pEmail);
                    divInformacoes.appendChild(pComputador);
                    divFuncionario.appendChild(divInformacoes)

                    var divBotoes = document.createElement("div");
                    divBotoes.className = "div_botoes";

                    var divNivel = document.createElement("div");
                    var spanNivel = document.createElement("span");
                    var selectNivel = document.createElement("select");
                    var option1 = document.createElement("option");
                    var option2 = document.createElement("option");
                    var option3 = document.createElement("option");
                    var option4 = document.createElement("option");
                    spanNivel.innerHTML = "NÍVEL DE ACESSO";
                    divNivel.className = "div_botao1";
                    selectNivel.name = "acesso";
                    selectNivel.className = "select_acesso";
                    selectNivel.id = `select_acesso-${idFuncionario}`;
                    option1.value = "nivel1";
                    option2.value = "nivel2";
                    option3.value = "nivel3";
                    option4.value = "nivel4";
                    option1.innerHTML = "Lílas";
                    option2.innerHTML = "Magenta";
                    option3.innerHTML = "Violeta";
                    option4.innerHTML = "Púrpura";

                    selectNivel.appendChild(option1);
                    selectNivel.appendChild(option2);
                    selectNivel.appendChild(option3);
                    selectNivel.appendChild(option4);
                    divNivel.appendChild(spanNivel);
                    divNivel.appendChild(selectNivel);
                    divFuncionario.appendChild(divNivel);

                    if(acessoUser == 1) selectNivel.value = "nivel1"
                    else if (acessoUser == 2) selectNivel.value = "nivel2"
                    else if (acessoUser == 3) selectNivel.value = "nivel3"
                    else if (acessoUser == 4) selectNivel.value = "nivel4"

                    selectNivel.addEventListener("change", function() {
                        var idselectNivel = this.id;
                        idselectNivel = idselectNivel.split('-')[1];
                        var select = document.getElementById(`select_acesso-${idselectNivel}`)
                        var opcaoSelecionada = select.options[select.selectedIndex].text;
                        var tipo = 2;
                        if (opcaoSelecionada == "Lílas") tipo = 1;
                        else if (opcaoSelecionada == "Violeta") tipo = 3;
                        else if (opcaoSelecionada == "Púrpura") tipo = 4;
                        mudarNivelAcesso(idselectNivel, tipo);
                    });

                    var divAndar = document.createElement("div");
                    var spanAndar = document.createElement("span");
                    var selectAndar = document.createElement("select");
                    spanAndar.innerHTML = "ANDAR";
                    divAndar.className = "div_botao1";
                    selectAndar.name = "andares";
                    selectAndar.className = "select_andares";
                    selectAndar.id = `andares-${idFuncionario}`;
                    buscarAndares(idFuncionario);
                    
                    divAndar.appendChild(spanAndar);
                    divAndar.appendChild(selectAndar);
                    divFuncionario.appendChild(divAndar);
                    
                    selectAndar.addEventListener("change", function() {
                        var idselectAndar = this.id;
                        idselectAndar = idselectAndar.split('-')[1];
                        var select = document.getElementById(`andares-${idselectAndar}`)
                        var opcaoSelecionada = select.options[select.selectedIndex].value;
                        opcaoSelecionada = opcaoSelecionada.split('-')[1][0];
                        mudarAndar(idselectAndar, opcaoSelecionada);                        
                    });


                    var divAlerta = document.createElement("div");
                    var spanAlerta = document.createElement("span");
                    var buttonAlerta = document.createElement("button");
                    divAlerta.className = "div_botao1 div_botao2";
                    buttonAlerta.className = "button_alerta";
                    spanAlerta.innerHTML = "ENVIAR ALERTA";
                    buttonAlerta.innerHTML = "ENVIAR";
                    buttonAlerta.id = `button-${idFuncionario}`;
                    buttonAlerta.addEventListener('click', function () {
                        var idButtonAlerta = this.id;
                        idButtonAlerta = idButtonAlerta.split('-')[1];
                        enviarAlerta(idButtonAlerta);
                    });
                    divAlerta.appendChild(spanAlerta);
                    divAlerta.appendChild(buttonAlerta);
                    divFuncionario.appendChild(divAlerta);
                    
                    var divAtividade = document.createElement("div");
                    var spanAtividade = document.createElement("span");
                    var divAtividadeTexto = document.createElement("div");
                    var spanAtividadeTexto = document.createElement("span");
                    divAtividade.className = "div_botao1 div_botao3";
                    divAtividadeTexto.className = "div_atividade";
                    spanAtividade.innerHTML = "Atividade";
                    spanAtividadeTexto.innerHTML = "ATIVO";
                    if (respostaJson[i].dataHoraEntrada == null || respostaJson[i].dataHoraEntrada != null && respostaJson[i].dataHoraSaida != null) spanAtividadeTexto.innerHTML = "INATIVO";
                    divAtividadeTexto.appendChild(spanAtividadeTexto);
                    divAtividade.appendChild(spanAtividade);
                    divAtividade.appendChild(divAtividadeTexto);
                    divFuncionario.appendChild(divAtividade);
                    
                    divFuncionarios.appendChild(divFuncionario);
                }
                setTimeout(() => {
                    for (let i = 0; i < respostaJson.length; i++) {
                        var idFuncionario = respostaJson[i].idFuncionario;
                        var selectAndar = document.getElementById(`andares-${idFuncionario}`);
                        var andarUser = respostaJson[i].fkAndar;
                        if (andarUser == null) {
                            selectAndar.value = `andar-0`;
                        } else {
                            selectAndar.value = `andar-${andarUser}${idFuncionario}`;
                        }
                    }
                }, 100);
            }
        } catch (erro) {
            console.log("Erro: ", erro);
        }
    }
    async function mudarNivelAcesso(idFuncionario, tipo){
        try {
            var resposta = await fetch("/funcionarios/mudarNivelAcesso", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idFuncionarioServer: idFuncionario,
                    tipoServer: tipo,
                })
            });
            if (resposta.ok) {
                var respostaJson = await resposta.json();
                console.log('JSON: ', respostaJson);
            }
        } catch (erro) {
            console.log("Erro: ", erro);
        }
    }
    async function mudarAndar(idFuncionario, andar){
        try {
            var resposta = await fetch("/funcionarios/mudarAndar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idFuncionarioServer: idFuncionario,
                    andarServer: andar,
                })
            });
            if (resposta.ok) {
                var respostaJson = await resposta.json();
                console.log('JSON: ', respostaJson);
            }
        } catch (erro) {
            console.log("Erro: ", erro);
        }
    }
    const atual = document.getElementById('option4');
    atual.style.backgroundColor = "blueviolet";
</script>